{% extends "layout.html" %}

{% block title %}Interventions Calendar - EduCare{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-calendar-alt me-2"></i>Interventions Calendar</h2>
            <p class="text-muted">View scheduled interventions in calendar format</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('intervention_bp.create_intervention') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Create Intervention
            </a>
            <a href="{{ url_for('intervention_bp.interventions_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i> List View
            </a>
        </div>
    </div>

    <!-- Month Navigation -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <a href="?month={{ month - 1 if month > 1 else 12 }}&year={{ year if month > 1 else year - 1 }}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </div>
                <div class="col-md-4 text-center">
                    <h4 class="mb-0">
                        {{ ['January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'][month - 1] }} 
                        {{ year }}
                    </h4>
                </div>
                <div class="col-md-4 text-end">
                    <a href="?month={{ month + 1 if month < 12 else 1 }}&year={{ year if month < 12 else year + 1 }}" 
                       class="btn btn-outline-primary">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="card">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Legend -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="mb-3">Legend</h5>
            <div class="row">
                <div class="col-md-3">
                    <span class="badge bg-danger me-2">■</span> Critical Priority
                </div>
                <div class="col-md-3">
                    <span class="badge bg-warning me-2">■</span> High Priority
                </div>
                <div class="col-md-3">
                    <span class="badge bg-info me-2">■</span> Medium Priority
                </div>
                <div class="col-md-3">
                    <span class="badge bg-success me-2">■</span> Low Priority
                </div>
            </div>
        </div>
    </div>

    <!-- Interventions List for Selected Month -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Interventions This Month
                <span class="badge bg-secondary">{{ interventions_by_date|length }}</span>
            </h5>
        </div>
        <div class="card-body">
            {% if interventions_by_date %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Student</th>
                            <th>Type</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for date, interventions in interventions_by_date.items()|sort %}
                        {% for intervention in interventions %}
                        <tr>
                            <td>{{ intervention.scheduled_date.strftime('%b %d, %Y') }}</td>
                            <td>
                                <a href="{{ url_for('student_bp.student_profile', student_id=intervention.student_id) }}">
                                    {{ intervention.student.name }}
                                </a>
                            </td>
                            <td>{{ intervention.intervention_type }}</td>
                            <td>
                                <span class="badge bg-{{ 'danger' if intervention.priority == 'Critical' else 'warning' if intervention.priority == 'High' else 'info' if intervention.priority == 'Medium' else 'success' }}">
                                    {{ intervention.priority or 'Medium' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if intervention.status == 'Completed' else 'warning' if intervention.status == 'In Progress' else 'primary' }}">
                                    {{ intervention.status }}
                                </span>
                            </td>
                            <td>{{ intervention.assigned_to or 'Unassigned' }}</td>
                            <td>
                                <a href="{{ url_for('intervention_bp.intervention_detail', intervention_id=intervention.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No interventions scheduled for this month.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Simple calendar rendering
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const month = {{ month }};
    const year = {{ year }};
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = new Date(year, month, 0).getDate();
    
    // Interventions by date
    const interventionsByDate = {{ interventions_by_date|tojson|safe }};
    
    // Create calendar HTML
    let html = '<table class="table table-bordered calendar-table">';
    html += '<thead><tr>';
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        html += `<th class="text-center">${day}</th>`;
    });
    html += '</tr></thead><tbody><tr>';
    
    // Empty cells before first day
    for (let i = 0; i < firstDay; i++) {
        html += '<td class="calendar-day empty"></td>';
    }
    
    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        if ((firstDay + day - 1) % 7 === 0 && day !== 1) {
            html += '</tr><tr>';
        }
        
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const interventions = interventionsByDate[dateStr] || [];
        
        html += '<td class="calendar-day">';
        html += `<div class="day-number">${day}</div>`;
        
        if (interventions.length > 0) {
            html += '<div class="interventions-list">';
            interventions.forEach(intervention => {
                const priorityClass = intervention.priority === 'Critical' ? 'danger' : 
                                     intervention.priority === 'High' ? 'warning' :
                                     intervention.priority === 'Medium' ? 'info' : 'success';
                html += `<div class="intervention-item bg-${priorityClass} bg-opacity-25">`;
                html += `<a href="/interventions/${intervention.id}" class="text-decoration-none text-dark">`;
                html += `<small>${intervention.student.name}</small>`;
                html += '</a></div>';
            });
            html += '</div>';
        }
        
        html += '</td>';
    }
    
    // Empty cells after last day
    const lastDayCells = (firstDay + daysInMonth) % 7;
    if (lastDayCells !== 0) {
        for (let i = lastDayCells; i < 7; i++) {
            html += '<td class="calendar-day empty"></td>';
        }
    }
    
    html += '</tr></tbody></table>';
    calendarEl.innerHTML = html;
});
</script>

<style>
.calendar-table {
    width: 100%;
    table-layout: fixed;
}

.calendar-day {
    height: 120px;
    vertical-align: top;
    padding: 5px;
    position: relative;
}

.calendar-day.empty {
    background-color: #f8f9fa;
}

.day-number {
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 14px;
}

.interventions-list {
    font-size: 11px;
}

.intervention-item {
    padding: 2px 4px;
    margin-bottom: 2px;
    border-radius: 3px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.intervention-item:hover {
    opacity: 0.8;
}
</style>
{% endblock %}
