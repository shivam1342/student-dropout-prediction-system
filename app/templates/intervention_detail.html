{% extends "layout.html" %}

{% block title %}Intervention Detail - EduCare{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-hands-helping me-2"></i>Intervention Details
                </h2>
                <div>
                    {% if intervention.status != 'Completed' and intervention.status != 'Cancelled' %}
                    <a href="{{ url_for('intervention_bp.edit_intervention', intervention_id=intervention.id) }}" 
                       class="btn btn-outline-secondary">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                    <a href="{{ url_for('intervention_bp.complete_intervention', intervention_id=intervention.id) }}" 
                       class="btn btn-success">
                        <i class="fas fa-check me-1"></i> Complete
                    </a>
                    {% endif %}
                    <a href="{{ url_for('intervention_bp.interventions_list') }}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i> Back to List
                    </a>
                </div>
            </div>

            <!-- Main Intervention Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">{{ intervention.intervention_type }}</h4>
                        <div>
                            {% if intervention.priority == 'Critical' %}
                            <span class="badge bg-danger fs-6">{{ intervention.priority }}</span>
                            {% elif intervention.priority == 'High' %}
                            <span class="badge bg-warning fs-6">{{ intervention.priority }}</span>
                            {% elif intervention.priority == 'Medium' %}
                            <span class="badge bg-info fs-6">{{ intervention.priority }}</span>
                            {% else %}
                            <span class="badge bg-success fs-6">{{ intervention.priority or 'Low' }}</span>
                            {% endif %}
                            
                            {% if intervention.status == 'Completed' %}
                            <span class="badge bg-success fs-6">{{ intervention.status }}</span>
                            {% elif intervention.status == 'In Progress' %}
                            <span class="badge bg-warning fs-6">{{ intervention.status }}</span>
                            {% elif intervention.status == 'Cancelled' %}
                            <span class="badge bg-secondary fs-6">{{ intervention.status }}</span>
                            {% else %}
                            <span class="badge bg-primary fs-6">{{ intervention.status }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Student Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5><i class="fas fa-user-graduate me-2"></i>Student Information</h5>
                            <p class="mb-1">
                                <strong>Name:</strong> 
                                <a href="{{ url_for('student_bp.student_profile', student_id=intervention.student_id) }}">
                                    {{ intervention.student.name }}
                                </a>
                            </p>
                            <p class="mb-1"><strong>Student ID:</strong> {{ intervention.student.student_id }}</p>
                            <p class="mb-0"><strong>Email:</strong> {{ intervention.student.email }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-info-circle me-2"></i>Intervention Details</h5>
                            <p class="mb-1"><strong>Scheduled Date:</strong> {{ intervention.scheduled_date.strftime('%B %d, %Y') if intervention.scheduled_date else 'N/A' }}</p>
                            <p class="mb-1"><strong>Created:</strong> {{ intervention.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            <p class="mb-0"><strong>Assigned To:</strong> {{ intervention.assigned_to or 'Unassigned' }}</p>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <h5><i class="fas fa-file-alt me-2"></i>Description</h5>
                        <p>{{ intervention.description }}</p>
                    </div>

                    <!-- Alert Link (if created from alert) -->
                    {% if intervention.alert_id %}
                    <div class="alert alert-info">
                        <i class="fas fa-bell me-2"></i>
                        <strong>Created from Alert:</strong> 
                        <a href="{{ url_for('alert_bp.alert_detail', alert_id=intervention.alert_id) }}">
                            View Alert #{{ intervention.alert_id }}
                        </a>
                    </div>
                    {% endif %}

                    <!-- Completion Details (if completed) -->
                    {% if intervention.status == 'Completed' %}
                    <div class="border-top pt-3 mt-3">
                        <h5><i class="fas fa-check-circle me-2 text-success"></i>Completion Details</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Completed Date:</strong> {{ intervention.completed_date.strftime('%B %d, %Y') if intervention.completed_date else 'N/A' }}</p>
                                <p class="mb-1"><strong>Effectiveness Rating:</strong> 
                                    {% if intervention.effectiveness_rating %}
                                    <span class="badge bg-info">{{ intervention.effectiveness_rating }}/5</span>
                                    {% for i in range(intervention.effectiveness_rating) %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% endfor %}
                                    {% for i in range(5 - intervention.effectiveness_rating) %}
                                    <i class="far fa-star text-warning"></i>
                                    {% endfor %}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Outcome:</strong> {{ intervention.outcome or 'N/A' }}</p>
                                <p class="mb-1"><strong>Follow-up Required:</strong> 
                                    {% if intervention.follow_up_required %}
                                    <span class="badge bg-warning">Yes</span>
                                    {% if intervention.follow_up_date %}
                                    - {{ intervention.follow_up_date.strftime('%B %d, %Y') }}
                                    {% endif %}
                                    {% else %}
                                    <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if intervention.notes %}
                        <div class="mt-2">
                            <strong>Notes:</strong>
                            <p class="mb-0">{{ intervention.notes }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Created -->
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6>Intervention Created</h6>
                                <p class="text-muted mb-0">{{ intervention.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            </div>
                        </div>

                        <!-- Scheduled -->
                        {% if intervention.scheduled_date %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6>Scheduled</h6>
                                <p class="text-muted mb-0">{{ intervention.scheduled_date.strftime('%B %d, %Y') }}</p>
                            </div>
                        </div>
                        {% endif %}

                        <!-- In Progress -->
                        {% if intervention.status == 'In Progress' or intervention.status == 'Completed' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6>In Progress</h6>
                                <p class="text-muted mb-0">Status updated</p>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Completed -->
                        {% if intervention.status == 'Completed' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6>Completed</h6>
                                <p class="text-muted mb-0">{{ intervention.completed_date.strftime('%B %d, %Y at %I:%M %p') if intervention.completed_date else 'Completed' }}</p>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Follow-up -->
                        {% if intervention.follow_up_required and intervention.follow_up_date %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6>Follow-up Required</h6>
                                <p class="text-muted mb-0">{{ intervention.follow_up_date.strftime('%B %d, %Y') }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('student_bp.student_profile', student_id=intervention.student_id) }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-user me-1"></i> View Student Profile
                        </a>
                        {% if intervention.alert_id %}
                        <a href="{{ url_for('alert_bp.alert_detail', alert_id=intervention.alert_id) }}" 
                           class="btn btn-outline-warning">
                            <i class="fas fa-bell me-1"></i> View Related Alert
                        </a>
                        {% endif %}
                        {% if intervention.status != 'Completed' %}
                        <a href="{{ url_for('intervention_bp.complete_intervention', intervention_id=intervention.id) }}" 
                           class="btn btn-success">
                            <i class="fas fa-check me-1"></i> Complete Intervention
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Other Interventions for this Student -->
            {% if other_interventions %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Other Interventions</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for other in other_interventions %}
                    <a href="{{ url_for('intervention_bp.intervention_detail', intervention_id=other.id) }}" 
                       class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ other.intervention_type }}</strong>
                                <br>
                                <small class="text-muted">{{ other.scheduled_date.strftime('%Y-%m-%d') if other.scheduled_date else 'N/A' }}</small>
                            </div>
                            <span class="badge bg-{{ 'success' if other.status == 'Completed' else 'primary' }}">
                                {{ other.status }}
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -26px;
    top: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid white;
}

.timeline-content h6 {
    margin-bottom: 5px;
    font-weight: 600;
}
</style>
{% endblock %}
